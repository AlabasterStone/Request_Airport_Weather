<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <title>查询机场天气METAR&TAF</title>
</head>

<body>
    <p id="ReadText"></p>


    <script type="text/javascript">
        let RequestAirport = "ZBAA";

        var strhref = window.location.href;
        strhref = strhref.substring(strhref.lastIndexOf("/") + 1);
        strhref = strhref.substring(0, 4);
        RequestAirport = strhref;

        let url = window.location.search;
        if (url != "") {
            url = url.substring(1);
            var datas = url.split('&');
            RequestAirport = datas[0].split('=')[1];
        }

        RequestAirport = RequestAirport.toUpperCase();

        var Alltext = "";

        const jsonReading = {
            "0": "洞",
            "1": "腰",
            "2": "两",
            "3": "3",
            "4": "四",
            "5": "五",
            "6": "六",
            "7": "拐",
            "8": "八",
            "9": "九",
            "A": "Alpha",
            "B": "Bravo",
            "C": "Charlie",
            "D": "Delta",
            "E": "Echo",
            "F": "Foxtrot",
            "G": "Golf",
            "H": "Hotel",
            "I": "India",
            "J": "Juliet",
            "K": "Kilo",
            "L": "Lima",
            "M": "Mike",
            "N": "November",
            "O": "Oscar",
            "P": "Papa",
            "Q": "Quebec",
            "R": "Romeo",
            "S": "Sierra",
            "T": "Tango",
            "U": "Uniform",
            "V": "Victor",
            "W": "Whiskey",
            "X": "X-ray",
            "Y": "Yankee",
            "Z": "Zulu",
            "-": "零下",
            "+": "洞 洞 洞"
        };

        const jsonRunwayReading = {
            "0": "洞",
            "1": "腰",
            "2": "两",
            "3": "叁",
            "4": "四",
            "5": "五",
            "6": "六",
            "7": "拐",
            "8": "八",
            "9": "九",
            "L": "左",
            "M": "中",
            "R": "右"
        };

        const jsonweatherphen = {
            "-": "轻微的",
            "+": "重度的",
            "MI": "浅的",
            "BC": "散片状的",
            "PR": "一部分",
            "BL": "风吹",
            "DR": "飘动",
            "SH": "阵性的",
            "FZ": "冰冻的",
            "VC": "机场附近的",
            "TS": "雷暴的",
            "FZ": "冰冻",
            "DZ": "毛毛雨",
            "RA": "雨",
            "SN": "雪",
            "SG": "米雪",
            "IC": "冰针 或 冰晶",
            "PL": "冰粒",
            "PE": "冰粒",
            "GR": "冰雹",
            "GS": "小冰雹",
            "BR": "轻雾",
            "FG": "雾",
            "FU": "烟",
            "VA": "火山灰",
            "DU": "浮沉",
            "SA": "扬沙",
            "HZ": "霾",
            "PO": "尘旋风 或 沙旋风 或 尘卷风",
            "SQ": "飑",
            "FC": "漏斗云 或 龙卷风",
            "SS": "沙暴",
            "DS": "尘暴",
            "UP": "降水量未知",
            "PY": "喷雾 或 海沫 或 水沫"
        };

        const jsonCloudscover = {
            "FEW": "少云，云底高，",
            "SCT": "疏云，云底高，",
            "BKN": "多云，云底高，",
            "OVC": "阴天，满天云，云底高，"
        };

        const jsonCloudstype = {
            "CB": "雨云，云状。",
            "TCU": "浓积云，云状。"
        };

        const jsonRunwayVisib = {
            "D": "有降低趋势。",
            "U": "有上升趋势。",
            "N": "无明险趋势变化。"
        };

        function ajaxAPI(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onload = function () {
                callback(xhr.responseText);
            };
            xhr.send();
        }

        function WordToOutput(data, IndexOfInterruption = [], callback) {
            var final = "";
            for (let i = 0; i < data.length; i++) {
                console.log(jsonReading[data[i]]);
                final += (jsonReading[data[i]] + " ");

                for (let j = 0; j < IndexOfInterruption.length; j++) {
                    if (i == IndexOfInterruption[j]) {
                        final += ", ";
                    }
                }
            }
            callback(final);
        }

        function RunwayToOutput(data, IndexOfInterruption = [], callback) {
            var final = "";
            for (let i = 0; i < data.length; i++) {
                console.log(jsonRunwayReading[data[i]]);
                final += (jsonRunwayReading[data[i]] + " ");
            }
            callback(final);
        }

        function TimeToOutputTime(data, callback) {
            let final = "";
            final += data.getDate();
            if (final.length == 1) {
                final = "0" + final;
            }

            let hour = "";
            hour += data.getHours();
            if (hour.length == 1) {
                hour = "0" + hour;
            }
            final += hour;

            let min = "";
            min += data.getMinutes();
            if (min.length == 1) {
                min = "0" + min;
            }
            final += min;

            WordToOutput(final, [1], function (output) {
                console.log(output);
                callback(output);
            });
        }

        function UTCtoCST(utcDateString, callback) {
            utcDateString = utcDateString.replace(' ', 'T');
            const utcDate = new Date(utcDateString);
            const beijingDate = new Date(utcDate.getTime() + 8 * 60 * 60 * 1000);

            TimeToOutputTime(beijingDate, function (data) {
                console.log(data);
                callback(data);
            });
        }

        function UNIXtoLocalTime(unixtime, callback) {
            const timestamp = unixtime;
            const date = new Date(timestamp * 1000);
            const LocaleDate = new Date(date.toLocaleString());

            console.log(LocaleDate);

            TimeToOutputTime(LocaleDate, function (data) {
                console.log("aaaaa" + data);
                callback(data);
            });
        }

        function AirportICAO(data, callback) {
            var finalICAO = "";
            for (let i = 0; i < data.length; i++) {
                console.log("ICAO: " + jsonReading[data[i]]);
                finalICAO += (jsonReading[data[i]] + " ");
            }
            callback(finalICAO);
        }

        function rawZuluTime(data, callback) {
            WordToOutput(data, [1, 5], function (output) {
                callback(output + "Time ");
            });
        }

        function WindAll(wdir, rawtext, wspd, wgst, callback) {
            var finalWind = "";
            var windir = "" + wdir;
            if (windir == "VRB") {
                finalWind += "风向不定。";
            } else {
                finalWind += "风向，";
                if (windir.length == 1) {
                    finalWind += (jsonReading["0"] + " ");
                    finalWind += (jsonReading["0"] + " ");
                }
                if (windir.length == 2) {
                    finalWind += (jsonReading["0"] + " ");
                }
                WordToOutput(windir, [], function (data) {
                    finalWind += (data + "度。 ");
                });
            }

            if (rawtext != "-1") {
                for (var i = 0; i < rawtext.length; i++) {
                    let len = rawtext[i].length;
                    if (rawtext[i].includes("MPS")) {
                        let j = i + 1;
                        if (j >= rawtext.length) { console.log(j); break; }
                        if (rawtext[j].length != 7) { console.log(j); continue; }
                        if (rawtext[j][3] == "V" && rawtext[j].length == 7) {
                            finalWind += ("具体风向， ");
                            WordToOutput(rawtext[j].substring(0, 3), [], function (data) {
                                finalWind += data;
                                console.log(finalWind);
                            });
                            finalWind += ("度，到， ");
                            WordToOutput(rawtext[j].substring(4, 7), [], function (data) {
                                finalWind += data;
                                console.log(finalWind);
                            });
                            finalWind += ("度。");
                        }
                    }
                }
            }

            finalWind += "风速, ";
            var windspeedMPS = "" + Math.round(wspd / 2);
            if (windspeedMPS < 10) {
                finalWind += (jsonReading["0"] + " ");
            }
            WordToOutput(windspeedMPS, [], function (data) {
                finalWind += data;
                console.log(finalWind);
            })

            if (wgst == null || wgst == 0) { } else {
                finalWind += "米秒。 阵风， ";
                var windGspeedMPS = "" + Math.round(wgst / 2);
                if (windGspeedMPS < 10) {
                    finalWind += (jsonReading["0"] + " ");
                }
                WordToOutput(windGspeedMPS, [], function (data) {
                    finalWind += data;
                    console.log(finalWind);
                })
            }
            finalWind += "米秒。";
            callback(finalWind);
        }

        function CloudsHeight(clouds, codemetar = -1, callback) {
            var finalcloud = "";
            var cloudtype = "";
            if (codemetar != "-1") {
                cloudtype = "，" + jsonCloudstype[codemetar];
            }

            for (let cloudsgroup = 0; cloudsgroup < clouds.length; cloudsgroup++) {
                if (clouds[cloudsgroup]["cover"] == "CAVOK" || clouds[cloudsgroup]["cover"] == "NSC" || clouds[cloudsgroup]["cover"] == "CLR" || clouds[cloudsgroup]["cover"] == "SKC" || clouds[cloudsgroup]["cover"] == null) {
                    finalcloud += "云层无险著影响 ";
                    if (clouds[cloudsgroup]["cover"] == "SKC") {
                        finalcloud += ("，碧空");
                    }
                    finalcloud += "。";
                } else if (clouds[cloudsgroup]["base"] != "null") {
                    var base = "" + parseInt(clouds[cloudsgroup]["base"]) * 3 / 10;
                    if (base.length == 2) {
                        base = "0" + base;
                    }
                    if (clouds[cloudsgroup]["type"] == null) {
                        WordToOutput(base, [], function (data) {
                            finalcloud += (jsonCloudscover[clouds[cloudsgroup]["cover"]] + " " + data + " 米。");
                        });
                    } else {
                        WordToOutput(base, [], function (data) {
                            finalcloud += (jsonCloudscover[clouds[cloudsgroup]["cover"]] + " " + data + " 米， " + jsonCloudstype[clouds[cloudsgroup]["type"]]);
                        });
                    }
                } else { }
            }
            finalcloud += cloudtype;
            callback(finalcloud);
        }

        function visibdis(nvis, callback) {
            var finalvisib = "";
            var visib = "" + nvis;
            console.log(visib);
            if (visib == "6+") {
                finalvisib += ("能见度，大于 " + jsonReading["1"] + " " + jsonReading["0"] + " 签米。 ");
                console.log(finalvisib);
            } else {
                nvis = parseFloat(nvis);
                nvis = nvis * 1.6;
                visib = "" + nvis;
                if (nvis < 0.05) {
                    finalvisib += ("能见度，小于" + jsonReading["5"] + " " + jsonReading["0"] + "米。 ");
                    console.log(finalvisib);
                } else if (nvis < 0.8) {
                    nvis = nvis * 10;
                    nvis = nvis * 2;
                    nvis = Math.round(nvis);
                    nvis = nvis / 2;
                    nvis = nvis * 100;
                    console.log(nvis);

                    visib = "" + nvis;

                    finalvisib += "能见度，";
                    WordToOutput(visib, [], function (data) {
                        finalvisib += data;
                    });
                    finalvisib += " 米。 ";
                    console.log(finalvisib);
                } else if (nvis < 5) {
                    nvis = nvis * 10;
                    nvis = Math.round(nvis);
                    nvis = nvis * 100;
                    console.log(nvis);

                    visib = "" + nvis;

                    finalvisib += "能见度，";
                    WordToOutput(visib, [], function (data) {
                        finalvisib += data;
                    });
                    finalvisib += " 米。 ";
                    console.log(finalvisib);
                } else {
                    nvis = Math.round(nvis);
                    nvis = nvis * 1000;
                    visib = "" + nvis;

                    finalvisib += "能见度，";
                    WordToOutput(visib, [], function (data) {
                        finalvisib += data;
                    });
                    finalvisib += " 米。 ";
                    console.log(finalvisib);
                }
            }
            callback(finalvisib);
        }

        function WeatherPhen(wxString, callback) {
            var finalwxs = "";
            if (wxString != null) {
                var wxarr = wxString.split(" ");
                for (let i = 0; i < wxarr.length; i++) {
                    if (wxarr[i].length == 2) {
                        console.log(jsonweatherphen[wxarr[i]]);
                        finalwxs += jsonweatherphen[wxarr[i]] + "。";
                    } else if (wxarr[i].length == 3) {
                        var str = wxarr[i][1] + wxarr[i][2];
                        finalwxs += (jsonweatherphen[wxarr[i][0]] + "，" + jsonweatherphen[str] + "。");
                        console.log(finalwxs);
                    } else if (wxarr[i].length == 4) {
                        var str1 = wxarr[i][0] + wxarr[i][1];
                        var str2 = wxarr[i][2] + wxarr[i][3];
                        finalwxs += (jsonweatherphen[str1] + "，" + jsonweatherphen[str2] + "。");
                        console.log(finalwxs);
                    } else if (wxarr[i].length == 5) {
                        var str1 = wxarr[i][0];
                        var str2 = wxarr[i][1] + wxarr[i][2];
                        var str3 = wxarr[i][3] + wxarr[i][4];
                        finalwxs += (jsonweatherphen[str1] + "，" + jsonweatherphen[str2] + "，" + jsonweatherphen[str3] + "。");
                        console.log(finalwxs);
                    }
                }
            }
            callback(finalwxs);
        }

        function RunwayDetails(eachpart, callback) {
            console.log("runway")
            console.log(eachpart)
            var finalRD = "";
            for (let i = 0; i < eachpart.length; i++) {
                if (eachpart[i].includes("R") && eachpart[i].includes("/")) {
                    var runway = eachpart[i].split("/")[0].substring(1);
                    var details = eachpart[i].split("/")[1].split("V");

                    RunwayToOutput(runway, [], function (data) {
                        finalRD += ("跑道 " + data);
                        console.log(finalRD);
                    });
                    console.log(details)
                    if (details.length == 1) {
                        if (details[0].includes("P2000")) {
                            finalRD += (" , 能见度， 大于 两 签米，");
                            if (details[0].length == "6") { finalRD += jsonRunwayVisib[details[0].substring(5)]; }

                            console.log(finalRD);

                        } else if (details[0].includes("M50")) {
                            finalRD += (" , 能见度， 小于 五 洞 米，");
                            if (details[0].length == "4") { finalRD += jsonRunwayVisib[details[0].substring(3)]; }
                            console.log(finalRD);

                        } else {
                            WordToOutput(details[0].substring(0, 4), [], function (data) {
                                finalRD += (" , 能见度， " + data + " 米， " + jsonRunwayVisib[details[0].substring(4, 5)]);
                                console.log(finalRD);
                            });
                        }
                    } else {
                        WordToOutput(details[0], [], function (data) {
                            finalRD += (" , 在观测时间范围内，能见度最低， " + data + " 米");
                            console.log(finalRD);
                        });
                        WordToOutput(details[1].substring(0, 4), [], function (data) {
                            finalRD += (" , 能见度最高， " + data + " 米， " + jsonRunwayVisib[details[1].substring(4, 5)]);
                            console.log(finalRD);
                        });
                    }
                }
            }
            callback(finalRD);
        }

        function VerticalVisib(eachpart, callback) {
            var finalVV = "";
            for (let i = 0; i < eachpart.length; i++) {
                if (eachpart[i].length > 4 && eachpart[i].includes("VV")) {
                    var num = eachpart[i].substring(2, 5);
                    if (num == "///") {
                        finalVV += ("天空状况不明，且没有垂直能见度报告。");
                        console.log(finalVV);
                    } else {
                        var num = "" + parseInt(num) * 30;
                        if (num.length == 2) {
                            num = "0" + num;
                        }
                        WordToOutput(num, [], function (data) {
                            finalVV += ("垂直能见度为，" + data + "米。");
                            console.log(finalVV);
                        });
                    }
                }
            }
            callback(finalVV);
        }

        function WindShear(eachpart, callback) {
            var finalWS = "";
            for (let i = 0; i < eachpart.length; i++) {
                if (eachpart[i] == "WS") {
                    let j = i + 1;
                    if (eachpart[j] == "ALL" || eachpart[j] == "All") {
                        finalWS += ("风切变，全部跑道都存在。");
                        break;
                    } else {
                        finalWS += ("存在风切变，");
                        for (j = j; j < eachpart.length; j++) {
                            if (eachpart[j].includes("RWY")) {
                                RunwayToOutput(eachpart[j].substring(3), [], function (data) {
                                    finalWS += ("在跑道 " + data + "，");
                                });
                            } else if (eachpart[j].includes("LDG")) {
                                RunwayToOutput(eachpart[j + 1].substring(3), [], function (data) {
                                    finalWS += ("在着陆跑道 " + data + "，");
                                });
                                j += 1;
                            } else if (eachpart[j].includes("TKOF")) {
                                RunwayToOutput(eachpart[j + 1].substring(3), [], function (data) {
                                    finalWS += ("在起飞跑道 " + data + "，");
                                });
                                j += 1;
                            } else { }
                        }
                        finalWS += ("中存在。");
                    }
                }
            }
            callback(finalWS);
        }

        function spiltRawInForecast(text, callback) {
            var finalspilt = [];
            var finalcnt = -1;

            for (let i = 0; i < text.length; i++) {
                if (text[i] == "BECMG" || text[i] == "TEMPO" || text[i].includes("FM") || text[i] == "TAF" || text[i] == RequestAirport) {
                    finalspilt.push([]);
                    finalcnt += 1;
                }
                finalspilt[finalcnt].push(text[i]);
                console.log(finalspilt);
            }
            finalcnt += 1;
            callback(finalspilt);
        }

        function processSearchText(searchtext, callback) {
            //https://aviationweather.gov/cgi-bin/data/metar.php?ids=ZBAA
            //https://aviationweather.gov/data/metar/
            //https://aviationweather.gov/cgi-bin/data/metar.php?ids=ZBAA&hours=0&order=id%2C-obs&sep=true&format=json
            //https://aviationweather.gov/cgi-bin/data/taf.php?ids=ZBAA&format=json

            //METAR

            var text = 'https://www.aviationweather.gov/cgi-bin/data/metar.php?ids=' + searchtext + '&format=json';
            ajaxAPI(text, function (responseText) {
                responseText = responseText.substring(1, responseText.length - 1);
                if (responseText.length <= 3) {
                    document.getElementById('ReadText').innerText = "\n\n\n\n\n\n\n\n机场输入错误，或查询不到机场数据！！！";
                    return;
                }
                var json = JSON.parse(responseText);
                var rawtext = json.rawOb.split(" ");
                var arrForecast = [];
                console.log(responseText);

                spiltRawInForecast(rawtext, function (arrdata) {
                    arrForecast = arrdata;
                    console.log(arrForecast);
                });

                //ICAO
                AirportICAO(json.icaoId, function (data) {
                    Alltext += "所选机场Meter播报, " + data + "。 ";
                    console.log(Alltext);
                });

                //通报时间
                rawZuluTime(rawtext[1], function (data) {
                    Alltext += "通报UTC时煎, " + data + "。 ";
                    console.log(Alltext);
                })

                //通报北京时间
                UTCtoCST(json.reportTime, function (data) {
                    Alltext += "通报北京时煎, " + data + "北京时 。 ";
                    console.log(Alltext);
                })

                //风_所有
                WindAll(json.wdir, rawtext, json.wspd, json.wgst, function (data) {
                    console.log(data);
                    Alltext += data;
                });

                //CAVOK
                for (var i = 2; i < rawtext.length; i++) {
                    if (rawtext[i] == "CAVOK") {
                        console.log("CAVOK");
                        Alltext += "好天气，CAV，OK。";
                    }
                }

                //天气现象
                var wxString = json.wxString;
                WeatherPhen(wxString, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                });

                console.log(arrForecast);
                var metarfirstclouds = "-1";
                console.log("cloudstype")
                console.log(arrForecast[0])
                for (let i = 0; i < arrForecast[0].length; i++) {
                    if (arrForecast[0][i].includes("CB")) {
                        metarfirstclouds = "CB";
                    }
                    if (arrForecast[0][i].includes("TCU")) {
                        metarfirstclouds = "TCU";
                    }
                }
                //云底高
                CloudsHeight(json.clouds, metarfirstclouds, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                });

                //能见度
                visibdis(json.visib, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                });

                //垂直能见度
                VerticalVisib(rawtext, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                });

                //跑道视程
                RunwayDetails(rawtext, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                });

                //风切变
                WindShear(rawtext, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                });

                //温度
                var finaltem = "温度，";
                var temp = "" + json.temp;
                var flagtemp = 0;
                if (temp.length == 1) { finaltem += (jsonReading["0"] + " "); }
                else if (temp.length == 2 && temp[0] == "-") { flagtemp = 1; }
                for (let i = 0; i < temp.length; i++) {
                    console.log(jsonReading[temp[i]]);
                    if (flagtemp == 1 && i == 1) { finaltem += (jsonReading["0"] + " "); }
                    finaltem += (jsonReading[temp[i]] + " ");
                };
                Alltext += (finaltem + "度。 ");

                //湿度
                var finaldewp = "露点，";
                var flagdewp = 0;
                var dewp = "" + json.dewp;
                if (dewp.length == 1) { finaldewp += (jsonReading["0"] + " "); }
                else if (dewp.length == 2 && dewp[0] == "-") { flagdewp = 1; }
                for (let i = 0; i < dewp.length; i++) {
                    console.log(jsonReading[dewp[i]])
                    if (flagdewp == 1 && i == 1) { finaldewp += (jsonReading["0"] + " "); }
                    finaldewp += (jsonReading[dewp[i]] + " ");
                };
                Alltext += (finaldewp + "度。 ");

                //气压
                var finalaltim = "修正海压，";
                var altim = "" + json.altim;
                for (let i = 0; i < altim.length; i++) {
                    console.log(jsonReading[altim[i]])
                    finalaltim += (jsonReading[altim[i]] + " ");
                };
                Alltext += (finalaltim + "。 ");
                console.log(Alltext);

                //NOSIG
                for (let i = 2; i < arrForecast[0].length; i++) {
                    if (arrForecast[0][i] == "NOSIG") {
                        console.log("NOSIG");
                        Alltext += "天气无明险变化，NO，SIG。";
                    }
                    if (arrForecast[0][i] == "NSW") {
                        console.log("NSW");
                        WordToOutput("NSW", [], function (dataword) {
                            Alltext += "无重要天气现象，代码，" + dataword + "。";
                        });
                    }
                }

                //预计
                var finaltg = "";

                for (let tgroup = 1; tgroup < arrForecast.length; tgroup++) {
                    var arrfore = arrForecast[tgroup];
                    if (arrfore[0] == "BECMG") {
                        finaltg += "预计，BECOMEING， ";
                    } else if (arrfore[0] == "TEMPO") {
                        finaltg += "预计暂时性天气，TEMPO， ";
                    } else { }

                    var stroldutctime = "";
                    var nowcnt = 2;
                    if (arrfore[1].length == 2) {
                        stroldutctime += arrfore[2];
                        nowcnt = 3;
                    } else {
                        stroldutctime = arrfore[1].substring(2);
                    }
                    stroldutctime = "" + stroldutctime;
                    var hour = parseInt(stroldutctime.substring(0, 2));
                    hour += 8;
                    if (hour >= 24) {
                        hour -= 24;
                    }
                    var strhour = "" + hour;
                    if (strhour.length == 1) {
                        strhour = "0" + strhour;
                    }
                    var min = stroldutctime.substring(2);
                    var timehm = hour + min;

                    if (arrfore[1].includes("TL")) {
                        finaltg += ("到，");
                        WordToOutput(timehm, [], function (data) {
                            finaltg += (data + " 北京时之后。");
                            console.log(finaltg);
                        });
                    } else if (arrfore[1].includes("FM")) {
                        finaltg += ("自，");
                        WordToOutput(timehm, [], function (data) {
                            finaltg += (data + " 北京时之后。");
                            console.log(finaltg);
                        });
                    } else if (arrfore[1].includes("AT")) {
                        finaltg += ("在，");
                        WordToOutput(timehm, [], function (data) {
                            finaltg += (data + " 北京时。");
                            console.log(finaltg);
                        });
                    } else { }

                    for (let i = nowcnt; i < arrfore.length; i++) {
                        console.log("iiii" + i);
                        if (arrfore[i] == "NSW") {
                            console.log("NSW");
                            WordToOutput("NSW", [], function (dataword) {
                                finaltg += "无重要天气现象，代码，" + dataword + "。";
                            });
                        }
                        if (arrfore[i] == "CAVOK") {
                            console.log("CAVOK");
                            finaltg += "好天气，CAV，OK。";
                        }

                        try {
                            //能见度
                            if (/^\d{4}$/.test(arrfore[i])) {
                                WordToOutput(arrfore[i], [], function (datavis) {
                                    finaltg += ("能见度为， " + datavis + " 米。");
                                });
                            }
                        } catch { };
                        try {
                            //气象
                            if (jsonweatherphen[arrfore[i]] == null || jsonweatherphen[arrfore[i]] == undefined) { }
                            else {
                                finaltg += (jsonweatherphen[arrfore[i]] + "。 ");
                            }
                        } catch { };

                        if (jsonCloudscover[arrfore[i].substring(0, 3)] == null || jsonCloudscover[arrfore[i].substring(0, 3)] == undefined) { } else {
                            var cover = jsonCloudscover[arrfore[i].substring(0, 3)];
                            var base = arrfore[i].substring(3, 6);
                            base = "" + parseInt(base) * 30;
                            if (base.length == 2) {
                                base = "0" + base;
                            }
                            var type = "";
                            if (arrfore[i].length != 6) {
                                type = jsonCloudstype[arrfore[i].substring(6)];
                            }
                            finaltg += (cover + base + " 米。" + type);
                        }
                    }
                    Alltext += finaltg;
                }

                //document.getElementById('ReadText').innerText = "\n\n\n\n\n\n\n\n" + Alltext + "\n\n\n\n";
                callback("\n\n\n\n\n\n\n\n" + Alltext + "\n\n\n\n", searchtext);
            });
        }
        processSearchText(RequestAirport, function (metarall, searchtext) {
            //TAF
            var texttaf = "https://aviationweather.gov/cgi-bin/data/taf.php?ids=" + searchtext + "&format=json";
            var tafall = "";
            tafall += "所选机场TAF播报。 ";

            var arrForecast = [];
            ajaxAPI(texttaf, function (responseTexttaf) {
                responseTexttaf = responseTexttaf.substring(1, responseTexttaf.length - 1);
                var jsontaf = JSON.parse(responseTexttaf);
                console.log(jsontaf);
                var rawtext = jsontaf.rawTAF.split(" ");

                //有效时间
                var taffinaltime = "";
                UNIXtoLocalTime(jsontaf.validTimeFrom, function (timestd) {
                    taffinaltime += ("TAF有效时煎，" + timestd + "北京时，到，");
                    console.log(taffinaltime);
                })
                UNIXtoLocalTime(jsontaf.validTimeTo, function (timestd) {
                    taffinaltime += (timestd + "北京时。 ");
                    console.log(taffinaltime);
                })
                tafall += taffinaltime;

                spiltRawInForecast(rawtext, function (arrdata) {
                    arrForecast = arrdata;
                    console.log(arrForecast);
                });

                for (let timegroup = 0; timegroup < jsontaf["fcsts"].length; timegroup++) {
                    if (timegroup == 0) {
                        //预报温度
                        var taffinaltemp = "";
                        var timemax, timemin;
                        try {
                            timemax = jsontaf.fcsts[0].temp[1][0];
                            timemin = jsontaf.fcsts[0].temp[1][1];

                            UNIXtoLocalTime(timemax.validTime, function (timestd) {
                                taffinaltemp += "预计，最高温度，";
                                var sfctempmax = "" + timemax.sfcTemp;
                                var flagtemp = 0;
                                if (sfctempmax.length == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                                else if (sfctempmax.length == 2 && sfctempmax[0] == "-") { flagtemp = 1; }
                                for (let i = 0; i < sfctempmax.length; i++) {
                                    console.log(jsonReading[sfctempmax[i]]);
                                    if (flagtemp == 1 && i == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                                    taffinaltemp += (jsonReading[sfctempmax[i]] + " ");
                                };
                                taffinaltemp += ("度，在，" + timestd + "北京时，时达到。 ");
                            })
                            UNIXtoLocalTime(timemin.validTime, function (timestd) {
                                taffinaltemp += "最低温度，";
                                var sfctempmax = "" + timemin.sfcTemp;

                                var flagtemp = 0;
                                if (sfctempmax.length == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                                else if (sfctempmax.length == 2 && sfctempmax[0] == "-") { flagtemp = 1; }
                                for (let i = 0; i < sfctempmax.length; i++) {
                                    console.log(jsonReading[sfctempmax[i]]);
                                    if (flagtemp == 1 && i == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                                    taffinaltemp += (jsonReading[sfctempmax[i]] + " ");
                                };
                                taffinaltemp += ("度，在，" + timestd + "北京时，时达到。 ");
                            })
                        } catch { }
                        tafall += taffinaltemp;
                    }

                    if (timegroup != 0 && jsontaf.fcsts[timegroup].fcstChange == "BECMG") {
                        var finalBECMG = "预计，BECOMING，";
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeFrom, function (timestd) {
                            finalBECMG += ("在， " + timestd + "北京时");
                            console.log(finalBECMG);
                        });
                        if (jsontaf.fcsts[timegroup].timeBec != null) {
                            UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeBec, function (timestd) {
                                finalBECMG += ("，到， " + timestd + "北京时，开始逐渐转变天气。 ");
                                console.log(finalBECMG);
                            });
                        }
                        if (arrForecast[timegroup][1].includes("AT")) {
                            if (arrForecast[timegroup][1].substring(2).length == 4) {
                                var hour = parseInt(arrForecast[timegroup][1].substring(2, 4));
                                hour += 8;
                                if (hour >= 24) {
                                    hour -= 24;
                                }
                                var strhour = "" + hour;
                                if (strhour.length == 1) {
                                    strhour = "0" + strhour;
                                }
                                var min = arrForecast[timegroup][1].substring(4, 6);

                                var timehm = hour + min;

                                WordToOutput(timehm, [], function (data) {
                                    finalBECMG += ("，开始发生天气转变，在 " + data + " 北京时。");
                                    console.log(finalBECMG);
                                });
                            } else if (arrForecast[timegroup][1] == "AT") {
                                var hour = parseInt(arrForecast[timegroup][2]);
                                hour += 8;
                                if (hour >= 24) {
                                    hour -= 24;
                                }
                                var strhour = "" + hour;
                                if (strhour.length == 1) {
                                    strhour = "0" + strhour;
                                }
                                var min = arrForecast[timegroup][1].substring(4, 6);

                                var timehm = hour + min;

                                WordToOutput(timehm, [], function (data) {
                                    finalBECMG += ("，开始发生天气转变，在 " + data + " 北京时。");
                                    console.log(finalBECMG);
                                });
                            }
                        }

                        if (jsontaf.fcsts[timegroup].probability != null) {
                            WordToOutput(jsontaf.fcsts[timegroup].probability, [], function (data) {
                                finalBECMG += ("气象转变概率为，" + data + " 。 ");
                            })
                        }

                        tafall += finalBECMG;
                    }

                    if (timegroup != 0 && jsontaf.fcsts[timegroup].fcstChange == "TEMPO") {
                        var finalTEMPO = "预计暂时性天气，代码，TEMPO 。";
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeFrom, function (timestd) {
                            finalTEMPO += ("在， " + timestd + "北京时，到， ");
                            console.log(finalTEMPO);
                        });
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeTo, function (timestd) {
                            finalTEMPO += (timestd + "北京时，结束此阶段短时波动天气。");
                            console.log(finalTEMPO);
                        });

                        if (jsontaf.fcsts[timegroup].probability != null) {
                            WordToOutput(jsontaf.fcsts[timegroup].probability, [], function (data) {
                                finalTEMPO += ("气象转变概率为，" + data + " 。 ");
                            })
                        }

                        tafall += finalTEMPO;
                    }

                    if (timegroup != 0 && jsontaf.fcsts[timegroup].fcstChange == "FM") {
                        var finalFM = "预计，FROM，天气从，";
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeFrom, function (timestd) {
                            finalFM += ("" + timestd + "北京时，到， ");
                            console.log(finalFM);
                        });
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeTo, function (timestd) {
                            finalFM += (timestd + "北京时，结束此阶段天气。");
                            console.log(finalFM);
                        });

                        if (jsontaf.fcsts[timegroup].probability != null) {
                            WordToOutput(jsontaf.fcsts[timegroup].probability, [], function (data) {
                                finalFM += ("气象转变概率为，" + data + " 。 ");
                            })
                        }
                        tafall += finalFM;
                    }

                    if (timegroup != 0 && jsontaf.fcsts[timegroup].fcstChange == "PROB") {
                        var finalPROB = "预计概率性天气，PROBOBALY，从，";
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeFrom, function (timestd) {
                            finalPROB += ("" + timestd + "北京时，到， ");
                            console.log(finalPROB);
                        });
                        UNIXtoLocalTime(jsontaf.fcsts[timegroup].timeTo, function (timestd) {
                            finalPROB += (timestd + "北京时，结束此阶段概率性天气。");
                            console.log(finalPROB);
                        });

                        if (jsontaf.fcsts[timegroup].probability != null) {
                            WordToOutput(jsontaf.fcsts[timegroup].probability, [], function (data) {
                                finalPROB += ("气象转变概率为，" + data + " 。 ");
                            })
                        }
                        tafall += finalPROB;
                    }

                    //风_全部
                    if (jsontaf.fcsts[timegroup].wdir != null) {
                        WindAll(jsontaf.fcsts[timegroup].wdir, rawtext, jsontaf.fcsts[timegroup].wspd, jsontaf.fcsts[timegroup].wgst, function (data) {
                            tafall += data;
                            console.log(tafall);
                        });
                    }

                    //CAVOK
                    if (timegroup == 0) {
                        for (var i = 0; i < rawtext.length; i++) {
                            if (rawtext[i] == "CAVOK") {
                                console.log("CAVOK");
                                tafall += "好天气，CAV，OK。";
                            }
                        }
                    }

                    //天气现象
                    var wxString = jsontaf.fcsts[timegroup].wxString;
                    WeatherPhen(wxString, function (data) {
                        tafall += data;
                        console.log(tafall);
                    });

                    //云底高
                    CloudsHeight(jsontaf.fcsts[timegroup].clouds, "-1", function (data) {
                        tafall += data;
                        console.log(tafall);
                    });

                    //能见度
                    if (jsontaf.fcsts[timegroup].visib != null) {
                        visibdis(jsontaf.fcsts[timegroup].visib, function (data) {
                            tafall += data;
                            console.log(Alltext);
                        });
                    }
                }

                //Output
                console.log(tafall);
                document.getElementById('ReadText').innerText = metarall + tafall + "已全部播报完毕，请确保已收到所有信息。";
            })
        });
    </script>
</body>