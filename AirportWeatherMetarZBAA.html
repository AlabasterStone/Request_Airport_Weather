<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <title>查询机场METAR</title>
</head>

<body>
    <p id="ReadText"></p>


    <script type="text/javascript">
        let RequestAirport = "ZBAA";

        let url = window.location.search;
        if (url != "") {
            url = url.substring(1);
            var datas = url.split('&');
            RequestAirport = datas[0].split('=')[1];
        }


        var Alltext = "";

        let jsonReading = {
            "0": "洞",
            "1": "腰",
            "2": "两",
            "3": "叁",
            "4": "四",
            "5": "五",
            "6": "六",
            "7": "拐",
            "8": "八",
            "9": "九",
            "A": "Alpha",
            "B": "Bravo",
            "C": "Charlie",
            "D": "Delta",
            "E": "Echo",
            "F": "Foxtrot",
            "G": "Golf",
            "H": "Hotel",
            "I": "India",
            "J": "Juliet",
            "K": "Kilo",
            "L": "Lima",
            "M": "Mike",
            "N": "November",
            "O": "Oscar",
            "P": "Papa",
            "Q": "Quebec",
            "R": "Romeo",
            "S": "Sierra",
            "T": "Tango",
            "U": "Uniform",
            "V": "Victor",
            "W": "Whiskey",
            "X": "X-ray",
            "Y": "Yankee",
            "Z": "Zulu",
            "-": "零下",
            "+": "洞 洞 洞"
        };

        let jsonweathercondition = {
            "-": "轻微的",
            "+": "重度的",
            "MI": "浅的",
            "BC": "散片状的",
            "PR": "一部分",
            "BL": "风吹",
            "DR": "飘动",
            "SH": "阵性的",
            "FZ": "冰冻",
            "VC": "机场附近",
            "TS": "雷暴"
        };

        let jsonweatherphen = {
            "DZ": "毛毛雨",
            "RA": "雨",
            "SN": "雪",
            "SG": "米雪",
            "IC": "冰针 或 冰晶",
            "PL": "冰粒",
            "PE": "冰粒",
            "GR": "冰雹",
            "GS": "小冰雹",
            "BR": "轻雾",
            "FG": "雾",
            "FU": "烟",
            "VA": "火山灰",
            "DU": "浮沉",
            "SA": "扬沙",
            "HZ": "霾",
            "PO": "发展完好的沙卷或尘卷",
            "SQ": "飑",
            "FC": "漏斗云 或 龙卷风",
            "SS": "沙暴",
            "DS": "尘暴"
        };


        function ajaxAPI(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onload = function () {
                callback(xhr.responseText);
            };
            xhr.send();
        }

        function WordToOutput(data, IndexOfInterruption = [], callback) {
            var final = "";
            for (let i = 0; i < data.length; i++) {
                console.log(jsonReading[data[i]])
                final += (jsonReading[data[i]] + " ");

                for (let j = 0; j < IndexOfInterruption.length; j++) {
                    if (i == IndexOfInterruption[j]) {
                        final += ", ";
                    }
                }
            }
            callback(final);
        }

        function TimeToOutputTime(data, callback) {
            let final = "";
            final += data.getDate();
            if (final.length == 1) {
                final = "0" + final;
            }

            let hour = "";
            hour += data.getHours();
            if (hour.length == 1) {
                hour = "0" + hour;
            }
            final += hour;

            let min = "";
            min += data.getMinutes();
            if (min.length == 1) {
                min = "0" + min;
            }
            final += min;

            WordToOutput(final, [1], function (output) {
                console.log(output);
                callback(output);
            });
        }

        function UTCtoCST(utcDateString, callback) {
            utcDateString = utcDateString.replace(' ', 'T');
            const utcDate = new Date(utcDateString);
            const beijingDate = new Date(utcDate.getTime() + 8 * 60 * 60 * 1000);

            TimeToOutputTime(beijingDate, function (data) {
                console.log(data);
                callback(data);
            });
        }

        function UNIXtoLocalTime(unixtime, callback) {
            const timestamp = unixtime;
            const date = new Date(timestamp * 1000);
            const LocaleDate = new Date(date.toLocaleString());

            console.log(LocaleDate);

            TimeToOutputTime(LocaleDate, function (data) {
                console.log("aaaaa" + data);
                callback(data);
            });
        }

        function AirportICAO(data, callback) {
            var finalICAO = "";
            for (let i = 0; i < data.length; i++) {
                console.log("ICAO: " + jsonReading[data[i]]);
                finalICAO += (jsonReading[data[i]] + " ");
            }
            callback(finalICAO);
        }

        function rawZuluTime(data, callback) {
            WordToOutput(data, [1, 5], function (output) {
                callback(output + "Time ");
            });
        }

        function WindAll(wdir, rawtext, wspd, wgst, callback) {
            var finalWind = "";
            var windir = "" + wdir;
            if (windir == "VRB") {
                finalWind += "风向不定。";
            } else {
                finalWind += "风向，";
                if (windir.length == 1) {
                    finalWind += (jsonReading["0"] + " ");
                    finalWind += (jsonReading["0"] + " ");
                }
                if (windir.length == 2) {
                    finalWind += (jsonReading["0"] + " ");
                }
                WordToOutput(windir, [], function (data) {
                    finalWind += (data + "度。 ");
                });
            }

            for (var i = 0; i < rawtext.length; i++) {
                let len = rawtext[i].length;
                if (rawtext[i].includes("MPS")) {
                    let j = i + 1;
                    if (j >= rawtext.length) { console.log(j); break; }
                    if (rawtext[j].length != 7) { console.log(j); continue; }
                    if (rawtext[j][3] == "V" && rawtext[j].length == 7) {
                        finalWind += ("具体风向， ");
                        WordToOutput(rawtext[j].substring(0, 3), [], function (data) {
                            finalWind += data;
                            console.log(finalWind);
                        });
                        finalWind += ("度，到， ");
                        WordToOutput(rawtext[j].substring(4, 7), [], function (data) {
                            finalWind += data;
                            console.log(finalWind);
                        });
                        finalWind += ("度。");
                    }
                }
            }

            finalWind += "风速, ";
            var windspeedMPS = "" + Math.round(wspd / 2);
            if (windspeedMPS < 10) {
                finalWind += (jsonReading["0"] + " ");
            }
            WordToOutput(windspeedMPS, [], function (data) {
                finalWind += data;
                console.log(finalWind);
            })

            if (wgst == null || wgst == 0) { } else {
                finalWind += "米秒。 阵风， ";
                var windGspeedMPS = "" + Math.round(wgst / 2);
                if (windGspeedMPS < 10) {
                    finalWind += (jsonReading["0"] + " ");
                }
                WordToOutput(windGspeedMPS, [], function (data) {
                    finalWind += data;
                    console.log(finalWind);
                })
            }
            finalWind += "米秒。";
            callback(finalWind);
        }

        function CloudsHeight(strcloud, text, callback) {
            var finalcloud = "";
            var ncloud = parseInt(strcloud) * 30;
            strcloud = "" + ncloud;
            if (strcloud.length == 2) {
                strcloud = "0" + strcloud;
            }
            finalcloud += text;
            WordToOutput(strcloud, [], function (data) {
                finalcloud += (data + "米。 ");
                console.log(finalcloud);
                callback(finalcloud);
            });
        }

        function visibdis(nvis, callback) {
            var finalvisib = "";
            var visib = "" + nvis;    
            console.log(visib);
            if (visib == "6+") {
                finalvisib += ("能见度，大于 " + jsonReading["1"] + " " + jsonReading["0"] + " 签米。 ");
                console.log(finalvisib);
            } else {
                nvis = parseInt(nvis);
                nvis = nvis * 1.6;
                visib = "" + nvis;
                if (nvis < 0.05) {
                    finalvisib += ("能见度，小于" + jsonReading["5"] + " " + jsonReading["0"] + "米。 ");
                    console.log(finalvisib);
                } else if (nvis < 0.8) {
                    nvis = nvis * 10;
                    nvis = nvis * 2;
                    nvis = Math.round(nvis);
                    nvis = nvis / 2;
                    nvis = nvis * 100;
                    console.log(nvis);

                    visib = "" + nvis;

                    finalvisib += "能见度，";
                    WordToOutput(visib, [], function (data) {
                        finalvisib += data;
                    });
                    finalvisib += " 米。 ";
                    console.log(finalvisib);
                } else if (nvis < 5) {
                    nvis = nvis * 10;
                    nvis = Math.round(nvis);
                    nvis = nvis * 100;
                    console.log(nvis);

                    visib = "" + nvis;

                    finalvisib += "能见度，";
                    WordToOutput(visib, [], function (data) {
                        finalvisib += data;
                    });
                    finalvisib += " 米。 ";
                    console.log(finalvisib);
                } else {
                    nvis = Math.round(nvis);
                    nvis = nvis * 1000;
                    visib = "" + nvis;

                    finalvisib += "能见度，";
                    WordToOutput(visib, [], function (data) {
                        finalvisib += data;
                    });
                    finalvisib += " 米。 ";
                    console.log(finalvisib);
                }
            }
            callback(finalvisib);
        }
        function processSearchText(searchtext, callback) {
            //https://aviationweather.gov/cgi-bin/data/metar.php?ids=ZBAA
            //https://aviationweather.gov/data/metar/
            //https://aviationweather.gov/cgi-bin/data/metar.php?ids=ZBAA&hours=0&order=id%2C-obs&sep=true&format=json
            //https://aviationweather.gov/cgi-bin/data/taf.php?ids=ZBAA&format=json

            //METAR

            var text = 'https://www.aviationweather.gov/cgi-bin/data/metar.php?ids=' + searchtext + '&format=json';
            ajaxAPI(text, function (responseText) {
                responseText = responseText.substring(1, responseText.length - 1);
                var json = JSON.parse(responseText);
                var rawtext = json.rawOb.split(" ");
                console.log(responseText)

                //ICAO
                AirportICAO(json.icaoId, function (data) {
                    Alltext += "所选机场Metar播报, " + data + "。 ";
                    console.log(Alltext);
                });

                //通报时间
                rawZuluTime(json.rawOb.split(" ")[1], function (data) {
                    Alltext += "通报UTC时煎, " + data + "。 ";
                    console.log(Alltext);
                })

                //通报北京时间
                UTCtoCST(json.reportTime, function (data) {
                    Alltext += "通报北京时煎, " + data + "北京时 。 ";
                    console.log(Alltext);
                })

                //风_所有
                WindAll(json.wdir, rawtext, json.wspd, json.wgst, function (data) {
                    console.log(data);
                    Alltext += data;
                });

                //CAVOK
                for (var i = 2; i < rawtext.length; i++) {
                    if (rawtext[i] == "CAVOK") {
                        console.log("CAVOK");
                        Alltext += "好天气，CAVOK。";
                    }
                }

                //天气现象
                var wxString = json.wxString;
                var finalwxs = "";
                if (wxString != null) {
                    var wxarr = wxString.split(" ");
                    for (let i = 0; i < wxarr.length; i++) {
                        if (wxarr[i].length == 2) {
                            console.log(jsonweatherphen[wxarr[i]]);
                            finalwxs += jsonweatherphen[wxarr[i]] + "。";
                        } else if (wxarr[i].length == 3) {
                            var str = wxarr[i][1] + wxarr[i][2];
                            finalwxs += (jsonweathercondition[wxarr[i][0]] + jsonweatherphen[str] + "。");
                            console.log(finalwxs);
                        } else if (wxarr[i].length == 4) {
                            var str1 = wxarr[i][0] + wxarr[i][1];
                            var str2 = wxarr[i][2] + wxarr[i][3];
                            finalwxs += (jsonweathercondition[str1] + jsonweatherphen[str2] + "。");
                            console.log(finalwxs);
                        }
                    }
                }
                Alltext += finalwxs;

                //云底高
                var finalcloud = "";
                for (var i = 2; i < rawtext.length; i++) {
                    if (rawtext[i].includes("FEW")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "少云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("SCT")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "疏云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("BKN")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "多云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("OVC")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "阴天，满天云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("NSC")) {
                        finalcloud += "云层无显著影响。";
                        console.log(finalcloud);
                    } else {
                        continue;
                    }
                }
                Alltext += finalcloud;

                //能见度
                visibdis(json.visib, function (data) {
                    Alltext += data;
                    console.log(Alltext);
                })

                //温度
                var finaltem = "温度，";
                var temp = "" + json.temp;
                var flagtemp = 0;
                if (temp.length == 1) { finaltem += (jsonReading["0"] + " "); }
                else if (temp.length == 2 && temp[0] == "-") { flagtemp = 1; }
                for (let i = 0; i < temp.length; i++) {
                    console.log(jsonReading[temp[i]]);
                    if (flagtemp == 1 && i == 1) { finaltem += (jsonReading["0"] + " "); }
                    finaltem += (jsonReading[temp[i]] + " ");
                };
                Alltext += (finaltem + "度。 ");

                //湿度
                var finaldewp = "露点，";
                var flagdewp = 0;
                var dewp = "" + json.dewp;
                if (dewp.length == 1) { finaldewp += (jsonReading["0"] + " "); }
                else if (dewp.length == 2 && dewp[0] == "-") { flagdewp = 1; }
                for (let i = 0; i < dewp.length; i++) {
                    console.log(jsonReading[dewp[i]])
                    if (flagdewp == 1 && i == 1) { finaldewp += (jsonReading["0"] + " "); }
                    finaldewp += (jsonReading[dewp[i]] + " ");
                };
                Alltext += (finaldewp + "度。 ");

                //气压
                var finalaltim = "修正海压，";
                var altim = "" + json.altim;
                for (let i = 0; i < altim.length; i++) {
                    console.log(jsonReading[altim[i]])
                    finalaltim += (jsonReading[altim[i]] + " ");
                };
                Alltext += (finalaltim + "。 ");
                console.log(Alltext);

                document.getElementById('ReadText').innerText = "\n\n\n\n\n\n\n\n" + Alltext + "\n\n\n\n";
                callback("\n\n\n\n\n\n\n\n" + Alltext + "\n\n\n\n", searchtext);
            });
        }
        processSearchText(RequestAirport, function (metarall, searchtext) {
            //TAF
            var texttaf = "https://aviationweather.gov/cgi-bin/data/taf.php?ids=" + searchtext + "&format=json";

            var tafall = "";
            tafall += "所选机场TAF播报。 ";


            ajaxAPI(texttaf, function (responseTexttaf) {
                responseTexttaf = responseTexttaf.substring(1, responseTexttaf.length - 1);
                var jsontaf = JSON.parse(responseTexttaf);
                console.log(jsontaf);
                var rawtext = jsontaf.rawTAF.split(" ");

                //有效时间
                var taffinaltime = "";
                UNIXtoLocalTime(jsontaf.validTimeFrom, function (timestd) {
                    taffinaltime += ("TAF有效时煎，" + timestd + "北京时，到，");
                    console.log(taffinaltime);
                })
                UNIXtoLocalTime(jsontaf.validTimeTo, function (timestd) {
                    taffinaltime += (timestd + "北京时。 ");
                    console.log(taffinaltime);
                })
                tafall += taffinaltime;

                //预报温度
                var taffinaltemp = "";
                var timemax = jsontaf.fcsts[0].temp[1][0];
                var timemin = jsontaf.fcsts[0].temp[1][1];

                UNIXtoLocalTime(timemax.validTime, function (timestd) {
                    taffinaltemp += "预计，最高温度，";
                    var sfctempmax = "" + timemax.sfcTemp;
                    var flagtemp = 0;
                    if (sfctempmax.length == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                    else if (sfctempmax.length == 2 && sfctempmax[0] == "-") { flagtemp = 1; }
                    for (let i = 0; i < sfctempmax.length; i++) {
                        console.log(jsonReading[sfctempmax[i]]);
                        if (flagtemp == 1 && i == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                        taffinaltemp += (jsonReading[sfctempmax[i]] + " ");
                    };
                    taffinaltemp += ("度，在，" + timestd + "北京时，时达到。 ");
                })
                UNIXtoLocalTime(timemin.validTime, function (timestd) {
                    taffinaltemp += "最低温度，";
                    var sfctempmax = "" + timemin.sfcTemp;

                    var flagtemp = 0;
                    if (sfctempmax.length == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                    else if (sfctempmax.length == 2 && sfctempmax[0] == "-") { flagtemp = 1; }
                    for (let i = 0; i < sfctempmax.length; i++) {
                        console.log(jsonReading[sfctempmax[i]]);
                        if (flagtemp == 1 && i == 1) { taffinaltemp += (jsonReading["0"] + " "); }
                        taffinaltemp += (jsonReading[sfctempmax[i]] + " ");
                    };
                    taffinaltemp += ("度，在，" + timestd + "北京时，时达到。 ");
                })
                tafall += taffinaltemp;

                //风_全部
                WindAll(jsontaf.fcsts[0].wdir, rawtext, jsontaf.fcsts[0].wspd, jsontaf.fcsts[0].wgst, function (data) {
                    tafall += data;
                    console.log(tafall);
                });
                
                //CAVOK
                for (var i = 0; i < rawtext.length; i++) {
                    if (rawtext[i] == "CAVOK") {
                        console.log("CAVOK");
                        tafall += "好天气，CAVOK。";
                    }
                }

                //天气现象
                var wxString = jsontaf.fcsts[0].wxString;
                var finalwxs = "";
                if (wxString != null) {
                    var wxarr = wxString.split(" ");
                    for (let i = 0; i < wxarr.length; i++) {
                        if (wxarr[i].length == 2) {
                            console.log(jsonweatherphen[wxarr[i]]);
                            finalwxs += jsonweatherphen[wxarr[i]] + "。";
                        } else if (wxarr[i].length == 3) {
                            var str = wxarr[i][1] + wxarr[i][2];
                            finalwxs += (jsonweathercondition[wxarr[i][0]] + jsonweatherphen[str] + "。");
                            console.log(finalwxs);
                        } else if (wxarr[i].length == 4) {
                            var str1 = wxarr[i][0] + wxarr[i][1];
                            var str2 = wxarr[i][2] + wxarr[i][3];
                            finalwxs += (jsonweathercondition[str1] + jsonweatherphen[str2] + "。");
                            console.log(finalwxs);
                        }
                    }
                }
                tafall += finalwxs;

                //云底高
                var finalcloud = "";
                for (var i = 2; i < rawtext.length; i++) {
                    if (rawtext[i].includes("FEW")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "少云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("SCT")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "疏云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("BKN")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "多云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("OVC")) {
                        CloudsHeight(rawtext[i].substring(3, 6), "阴天，满天云，云底高，", function (data) {
                            finalcloud += data;
                            console.log(finalcloud);
                        });
                    } else if (rawtext[i].includes("NSC")) {
                        finalcloud += "云层无显著影响。";
                        console.log(finalcloud);
                    } else {
                        continue;
                    }
                }
                tafall += finalcloud;

                //能见度
                visibdis(jsontaf.fcsts[0].visib, function (data) {
                    tafall += data;
                    console.log(Alltext);
                });

                //Output
                console.log(tafall);
                document.getElementById('ReadText').innerText = metarall + tafall;

            })
        });
    </script>
</body>